ALTER PROCEDURE [dbo].[sp_Chuyen_Chi_Nhanh] @SOCMND NVARCHAR(20),
	@MACNKHAC NVARCHAR(20)
AS
SET XACT_ABORT ON;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
BEGIN
	BEGIN DISTRIBUTED TRAN
		DECLARE @HO NVARCHAR(40)
		DECLARE @TEN NVARCHAR(10)
		DECLARE @DIACHI NVARCHAR(100)
		DECLARE @NGAYSINH DATETIME
		DECLARE @LUONG FLOAT	
							
		SELECT @HO = HO, @TEN = TEN, @DIACHI = DIACHI, @NGAYSINH = NGAYSINH, @LUONG = LUONG FROM NhanVien WHERE SOCMND = @SOCMND
		IF EXISTS(select MANV
				from LINK1.QLVT.dbo.NhanVien
				where SOCMND = @SOCMND)
		BEGIN
				UPDATE LINK1.QLVT.dbo.NhanVien
				SET TrangThaiXoa = 0
				WHERE SOCMND = @SOCMND
		END
		ELSE
		BEGIN
		    DROP TABLE IF EXISTS #tmp
            CREATE TABLE #tmp
            (
               MaxId INT
			)
		    INSERT INTO #tmp
			EXEC [sp_Get_Max_Id] 'NHANVIEN', 'MANV' 
			DECLARE @ID INT
			SELECT @ID = MaxId FROM #tmp
			INSERT INTO LINK1.QLVT.dbo.NhanVien (MANV,SOCMND, HO, TEN, DIACHI, NGAYSINH, LUONG, MACN, TRANGTHAIXOA)
			VALUES (@ID + 1, @SOCMND, @HO, @TEN, @DIACHI, @NGAYSINH, @LUONG, @MACNKHAC, 0)
		END
		UPDATE dbo.NhanVien
		SET TrangThaiXoa = 1
		WHERE SOCMND = @SOCMND
	COMMIT TRAN;
END
