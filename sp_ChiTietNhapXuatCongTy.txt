create PROCEDURE [dbo].[sp_ChiTietNhapXuatCongTy]
@TYPE NVARCHAR(4),
@DATEFROM DATE,
@DATETO DATE
AS
BEGIN
	BEGIN
		IF(@TYPE = 'NHAP')
		BEGIN
				SELECT FORMAT(NGAY,'MM-yyyy') AS THANGNAM, 
						TENVT, 
						SUM(SOLUONG) AS TONGSOLUONG,
						SUM(SOLUONG * DONGIA) AS TRIGIA
				FROM
					( SELECT NGAY,MAPN 
						FROM PhieuNhap
						WHERE  (( YEAR(NGAY) > YEAR(@DATEFROM)  OR  (MONTH(NGAY) >= MONTH(@DATEFROM) AND YEAR(NGAY)= YEAR(@DATEFROM) ))
	AND   (YEAR(NGAY)< YEAR(@DATETO) OR ( MONTH(NGAY) <= MONTH(@DATETO) AND  YEAR(NGAY)= YEAR(@DATETO) ))))PHIEU,
					( SELECT TENVT,MAVT FROM Vattu ) VT,
					( SELECT SOLUONG, DONGIA, MAPN,MAVT FROM CTPN) CT
				WHERE PHIEU.MAPN = CT.MAPN
				AND VT.MAVT = CT.MAVT
				GROUP BY FORMAT(NGAY,'MM-yyyy'), TENVT
				ORDER BY FORMAT(NGAY,'MM-yyyy'), TENVT
		END
		ELSE -- @LOAI = 'XUAT'
		BEGIN
					SELECT FORMAT(NGAY,'MM-yyyy') AS THANGNAM, 
						TENVT, 
						SUM(SOLUONG) AS TONGSOLUONG,
						SUM(SOLUONG * DONGIA) AS TRIGIA
					FROM
						( SELECT NGAY,MAPX
							FROM PhieuXuat
							WHERE (( YEAR(NGAY) > YEAR(@DATEFROM)  OR  (MONTH(NGAY) >= MONTH(@DATEFROM) AND YEAR(NGAY)= YEAR(@DATEFROM) ))
	AND   (YEAR(NGAY)< YEAR(@DATETO) OR ( MONTH(NGAY) <= MONTH(@DATETO) AND  YEAR(NGAY)= YEAR(@DATETO) ))))PHIEU,
						( SELECT TENVT,MAVT FROM Vattu ) VT,
						( SELECT SOLUONG, DONGIA, MAPX,MAVT FROM CTPX) CT
					WHERE PHIEU.MAPX = CT.MAPX
					AND VT.MAVT = CT.MAVT
					GROUP BY FORMAT(NGAY,'MM-yyyy'), TENVT
					ORDER BY FORMAT(NGAY,'MM-yyyy'), TENVT
		END
	END
END